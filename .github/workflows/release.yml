name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0.0)'
        required: true
        default: '2.0.0'

permissions:
  contents: write

jobs:
  lint:
    name: Lint
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict AudioType

  build:
    runs-on: macos-14
    needs: lint
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build AudioType
        run: swift build -c release

      - name: Create app bundle
        run: |
          mkdir -p AudioType.app/Contents/MacOS AudioType.app/Contents/Resources
          
          # Copy main binary
          cp .build/release/AudioType AudioType.app/Contents/MacOS/
          
          # Copy Info.plist and icon
          cp Resources/Info.plist AudioType.app/Contents/Info.plist
          cp Resources/AppIcon.icns AudioType.app/Contents/Resources/
          
          # Sign the app
          codesign --force --deep --sign - AudioType.app

      - name: Verify app bundle
        run: |
          test -f AudioType.app/Contents/MacOS/AudioType
          test -f AudioType.app/Contents/Info.plist
          codesign -v AudioType.app
          echo "App bundle verification passed!"

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -R AudioType.app dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "AudioType" -srcfolder dmg_contents -ov -format UDZO AudioType.dmg

      - name: Create ZIP
        run: zip -r AudioType.zip AudioType.app

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: AudioType v${{ steps.version.outputs.version }}
          body: |
            ## AudioType v${{ steps.version.outputs.version }}
            
            Voice-to-text for macOS powered by Groq cloud transcription (Whisper Large V3).
            
            ### What's New
            - Cloud-powered transcription via Groq API for significantly better accuracy
            - Self-serve: bring your own free Groq API key
            - Simplified build â€” no more whisper.cpp compilation required
            
            ### Installation
            1. Download `AudioType.dmg` or `AudioType.zip`
            2. Extract and move `AudioType.app` to your Applications folder
            3. Open the app and grant Microphone and Accessibility permissions
            4. Enter your free Groq API key (get one at https://console.groq.com/keys)
            5. Hold the fn key to dictate
            
            ### Requirements
            - macOS 14.0 or later
            - Apple Silicon or Intel Mac
            - Internet connection
            - Free Groq API key
            
            > Looking for the offline/local version? See [v1.1.1](https://github.com/PatelUtkarsh/audio-type/releases/tag/v1.1.1)
          files: |
            AudioType.dmg
            AudioType.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
